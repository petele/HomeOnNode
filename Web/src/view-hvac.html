<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="fb-document.html">
<link rel="import" href="fb-query.html">
<link rel="import" href="send-command.html">
<link rel="import" href="hon-icons.html">

<dom-module id="view-hvac">
  <template>
    <style include="shared-styles app-grid-style iron-flex">
      :host {
        display: block;
        --app-grid-item-height: reset;
      }
      .nest-details { text-align: right; }
      .secondary {
        color: var(--secondary-text-color);
      }
      summary {
        list-style: none;
        cursor: pointer;
        display: inline-block;
        float: right;
      }
      summary::-webkit-details-marker {
        display: none;
      }
      details {
        min-height: 2em;
      }
      details > summary {
        width: 100%;
        height: 2em;
        outline: none;
      }
    </style>

    <send-command id="sendCommand"></send-command>

    <fb-query path="state/nest/devices/thermostats" data="{{nestThermostats}}">
    </fb-query>

    <fb-document
      path="state/nest/structures/yzfxfqLcIvayvKiyjaAh82QUV2Uun0rbTYbmTYi356_a2tI5SqP3rA/away"
      data="{{nestState}}">
    </fb-document>

    <firebase-document
    path="config/HomeOnNode/hvac/autoHumidifier"
    data="{{autoHumidifier}}">
  </firebase-document>

    <fb-query path="config/HomeOnNode/nest/hvacAuto" data="{{nestHVACAuto}}">
    </fb-query>

    <div class="card">
      <div class="app-grid grid-one">
        <paper-toggle-button id="ptAway" checked="{{nestAway}}" on-change="awayChanged">
          Nest Away
        </paper-toggle-button>
      </div>
    </div>

    <div class="card">
      <div class="app-grid grid-one">
        <paper-toggle-button checked="{{autoHumidifier.enabled}}">
          Auto Humidfier
        </paper-toggle-button>
      </div>
      <div class="app-grid grid-two">
        <paper-input
            label="On Below"
            type="number"
            required
            min="0" max="50"
            value="{{autoHumidifier.onBelow}}">
        </paper-input>
        <paper-input
            label="Off Above"
            type="number"
            required
            min="20" max="90"
            value="{{autoHumidifier.offAbove}}">
        </paper-input>
      </div>
    </div>

    <div class="card">
      <div class="app-grid grid-two">
        <template is="dom-repeat" items="{{nestThermostats}}">
          <paper-dropdown-menu disabled label="[[item.name]]">
            <paper-listbox
              on-selected-changed="hvacModeChanged"
              slot="dropdown-content"
              class="dropdown-content"
              attr-for-selected="value"
              selected="[[item.hvac_mode]]">
              <paper-item value="heat">Heat</paper-item>
              <paper-item value="cool">Cool</paper-item>
              <paper-item value="off">Off</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
        </template>
      </div>
      <template is="dom-repeat" items="{{nestHVACAuto}}">
        <div class="app-grid grid-three">
          <div>[[item.$key]]</div>
          <paper-input
            label="Living Room"
            type="number"
            required
            min="60" max="80"
            value="[[item.LR]]"
            on-value-changed="lrTempChanged">
          </paper-input>
          <paper-input
            label="Bedroom"
            type="number"
            required
            min="60" max="80"
            value="[[item.BR]]"
            on-value-changed="brTempChanged">
          </paper-input>
        </div>
      </template>
    </div>

  </template>

  <script>
    class HVACView extends Polymer.Element {
      static get is() { return 'view-hvac'; }

      static get properties() {
        return {
          nestState: Object,
          nestAway: Boolean,
          nestThermostats: Object,
          lr: Object,
          lrChart: Object,
          lrChartData: Object,
          br: Object,
          brChart: Object,
          brChartData: Object,
          lrThermostatId: {
            type: String,
            value: 'dQ2cONq2P3MTSPzuctw3jrX_gKS0QBk1',
          },
          brThermostatId: {
            type: String,
            value: 'dQ2cONq2P3NPOgLG6WFYC7X_gKS0QBk1',
          },
          cronLogs: Array,
          firstFill: {
            type: Boolean,
            value: true,
          },
          showHumidity: {
            type: Boolean,
            value: false,
          },
          hvacMode: {
            type: String,
            value: 'heat',
          },
          autoHumidifier: {
            type: Object,
            value: {},
          },
        };
      }

      hvacModeChanged(evt, newVal) {
        // TODO: Not yet implemented.
        // eslint-disable-next-line no-console
        console.warn('NYI: Changing HVAC mode to...', newVal.value);
      }

      lrTempChanged(evt, newVal) {
        window.lastUserInput = Date.now();
        if (!evt.srcElement.validate()) {
          return;
        }
        const index = evt.model.index;
        this.set(`nestHVACAuto.${index}.LR`, newVal.value);
      }

      brTempChanged(evt, newVal) {
        window.lastUserInput = Date.now();
        if (!evt.srcElement.validate()) {
          return;
        }
        const index = evt.model.index;
        this.set(`nestHVACAuto.${index}.BR`, newVal.value);
      }

      userInteraction() {
        window.lastUserInput = Date.now();
      }

      awayChanged(e) {
        if (this.$.ptAway.checked === true) {
          this.$.sendCommand.send({nestState: 'AWAY'});
        } else if (this.$.ptAway.checked === false) {
          this.$.sendCommand.send({nestState: 'HOME'});
        }
      }
    }

    window.customElements.define(HVACView.is, HVACView);
  </script>
</dom-module>
